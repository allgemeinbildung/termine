<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Improved Gantt Chart (Full-Page)</title>
  <style>
    /* Make the page and container occupy the full viewport. */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden; /* We'll let the main container scroll. */
      font-family: Arial, sans-serif;
    }

    /* Main chart container: scrollable if content exceeds window size. */
    #chart-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: auto;
      box-sizing: border-box;
      border: 1px solid #ccc;
      background: #fff;
      padding: 1rem; /* Some padding inside the container */
    }

    /* Title / description at top, inside container so it can scroll too. */
    .chart-header {
      margin-bottom: 1rem;
    }

    /* The date-axis area (the horizontal ruler at the top) */
    .date-axis {
      position: absolute;
      top: 0;
      left: 0;
      height: 30px;
      background: #f9f9f9;
      border-bottom: 1px solid #999;
    }
    .date-tick {
      position: absolute;
      top: 0;
      width: 1px;
      height: 100%;
      background: #999;
    }
    .date-label {
      position: absolute;
      top: 2px;
      transform: translateX(-50%);
      font-size: 0.8em;
      color: #333;
    }

    /* "Today" line spans entire chart height. */
    .today-line {
      position: absolute;
      top: 0;
      width: 2px;
      background: red;
      pointer-events: none;
    }

    /* Each row (chapter) is placed absolutely in the chart. */
    .gantt-row {
      position: absolute;
      left: 0;
      height: 30px; /* row height */
    }

    /* Chapter label pinned to the left portion of the row. */
    .gantt-label {
      position: absolute;
      left: 0;
      width: 130px;
      text-align: right;
      padding-right: 10px;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
    }

    /* The main bar area to the right of the label. */
    .gantt-bar {
      position: absolute;
      top: 0;
      height: 30px;
      background-color: #4CAF50;
    }

    /* A small diamond marker to show oral exam date. */
    .exam-marker {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: orange;
      transform: rotate(45deg);
      top: 10px; /* roughly centered in a 30px row */
    }

    /* The completion checkbox. */
    .completion-checkbox {
      position: absolute;
      left: 0;
      top: 0;
      transform: translateX(-1.5rem); /* shift left from the label */
      margin-top: 5px;
    }

    /* Info text at the bottom of the container. */
    .info {
      margin-top: 1rem;
      font-size: 0.9em;
      color: #555;
    }
  </style>
</head>
<body>
  <!-- Main scrollable container -->
  <div id="chart-container">
    <div class="chart-header">
      <h1>Improved Gantt Chart (Full-Page)</h1>
      <p>
        This page loads a JSON file (e.g., <code>chapters/chapter_1.json</code>) based on
        <strong>?chapter=X</strong> in the URL (<code>?chapter=1</code>, <code>?chapter=2</code>, etc.).
      </p>
    </div>
  </div>

  <script>
    // === CONFIGURABLE PARAMETERS ===
    const PIXELS_PER_DAY = 5;   // Horizontal scale (px per day)
    const AXIS_HEIGHT = 30;     // Height for the top date axis
    const ROW_HEIGHT = 30;      // Height for each chapter row
    const LABEL_WIDTH = 130;    // Space on the left for the label
    // ===============================

    // Get ?chapter=X from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const chapterParam = urlParams.get('chapter') || "1";
    const jsonPath = `chapters/chapter_${chapterParam}.json`;

    // Container element
    const container = document.getElementById('chart-container');

    // Fetch the JSON data
    fetch(jsonPath)
      .then(res => {
        if (!res.ok) {
          throw new Error(`Could not load JSON: ${res.status} ${res.statusText}`);
        }
        return res.json();
      })
      .then(chapters => {
        buildGantt(chapters);
      })
      .catch(err => {
        console.error(err);
        container.textContent = "Error loading data. Check console for details.";
      });

    // Helper: parse "YYYY-MM-DD" into a Date
    function parseDate(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split("-");
      if (parts.length !== 3) return null;
      const [year, month, day] = parts.map(p => parseInt(p, 10));
      return new Date(year, month - 1, day);
    }

    function buildGantt(chapters) {
      // Parse and filter valid date ranges
      const data = chapters.map(ch => ({
        ...ch,
        start: parseDate(ch.startDate),
        due: parseDate(ch.dueDate),
        exam: parseDate(ch.oralExamDate)
      }))
      .filter(ch => ch.start && ch.due);

      if (data.length === 0) {
        container.innerHTML += "<p>No valid startDate/dueDate found in JSON.</p>";
        return;
      }

      // Determine the overall minStart and maxDue
      const minStart = new Date(Math.min(...data.map(ch => ch.start)));
      const maxDue = new Date(Math.max(...data.map(ch => ch.due)));

      // Calculate total chart width
      const msPerDay = 1000 * 60 * 60 * 24;
      const totalDays = Math.round((maxDue - minStart) / msPerDay);
      const chartWidth = totalDays * PIXELS_PER_DAY;

      // Chart height: axis + one row per item
      const chartHeight = AXIS_HEIGHT + data.length * ROW_HEIGHT;

      // Make the container big enough to hold the entire chart
      // (plus some padding on the right if desired)
      container.style.width = "100%";  // fill the browser width
      container.style.height = "100%"; // fill the browser height
      // We'll place absolutely positioned elements inside.

      // 1) Create the date-axis
      const axisDiv = document.createElement('div');
      axisDiv.className = "date-axis";
      axisDiv.style.width = chartWidth + "px";
      axisDiv.style.left = LABEL_WIDTH + "px";
      axisDiv.style.height = AXIS_HEIGHT + "px";
      container.appendChild(axisDiv);

      // Add weekly ticks for demonstration
      for (let d = new Date(minStart); d <= maxDue; d.setDate(d.getDate() + 7)) {
        const offsetDays = Math.round((d - minStart) / msPerDay);
        const xPos = offsetDays * PIXELS_PER_DAY;
        
        // Tick line
        const tick = document.createElement('div');
        tick.className = "date-tick";
        tick.style.left = xPos + "px";
        axisDiv.appendChild(tick);

        // Label
        const label = document.createElement('div');
        label.className = "date-label";
        label.style.left = xPos + "px";
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        label.textContent = `${d.getFullYear()}-${mm}-${dd}`;
        axisDiv.appendChild(label);
      }

      // 2) "Today" line if within range
      const today = new Date();
      if (today >= minStart && today <= maxDue) {
        const offsetToday = Math.round((today - minStart) / msPerDay);
        const todayX = offsetToday * PIXELS_PER_DAY + LABEL_WIDTH;
        const todayLine = document.createElement('div');
        todayLine.className = "today-line";
        todayLine.style.left = todayX + "px";
        todayLine.style.height = chartHeight + "px"; // span entire chart
        container.appendChild(todayLine);
      }

      // 3) Build each row
      data.forEach((ch, i) => {
        const rowTop = AXIS_HEIGHT + i * ROW_HEIGHT;

        // Create a container for the row
        const rowDiv = document.createElement('div');
        rowDiv.className = "gantt-row";
        rowDiv.style.top = rowTop + "px";
        rowDiv.style.width = (LABEL_WIDTH + chartWidth) + "px";
        container.appendChild(rowDiv);

        // The label (chapter #) on the left
        const labelSpan = document.createElement('span');
        labelSpan.className = "gantt-label";
        labelSpan.textContent = `Chapter ${ch.chapter}`;
        rowDiv.appendChild(labelSpan);

        // The bar offset
        const offsetDays = Math.round((ch.start - minStart) / msPerDay);
        const barLeft = offsetDays * PIXELS_PER_DAY + LABEL_WIDTH;

        // The bar width
        const durationDays = Math.round((ch.due - ch.start) / msPerDay);
        const barWidth = durationDays * PIXELS_PER_DAY;

        // The bar itself
        const barDiv = document.createElement('div');
        barDiv.className = "gantt-bar";
        barDiv.style.left = barLeft + "px";
        barDiv.style.width = barWidth + "px";
        barDiv.title = `Start: ${ch.startDate}, Due: ${ch.dueDate}`;
        rowDiv.appendChild(barDiv);

        // 3a) Show oral exam date if relevant and within range
        if (ch.oralExamRelevant === true && ch.exam) {
          if (ch.exam >= minStart && ch.exam <= maxDue) {
            const examOffset = Math.round((ch.exam - minStart) / msPerDay);
            const examLeft = examOffset * PIXELS_PER_DAY + LABEL_WIDTH;
            const examMarker = document.createElement('div');
            examMarker.className = "exam-marker";
            examMarker.style.left = examLeft + "px";
            examMarker.title = `Oral Exam: ${ch.oralExamDate}`;
            rowDiv.appendChild(examMarker);
          }
        }

        // 4) Completion checkbox
        const checkbox = document.createElement('input');
        checkbox.type = "checkbox";
        checkbox.className = "completion-checkbox";
        const storageKey = `improved-gantt-chapter${chapterParam}-row${i}-completed`;
        checkbox.checked = localStorage.getItem(storageKey) === "true";
        checkbox.addEventListener('change', () => {
          localStorage.setItem(storageKey, checkbox.checked.toString());
        });
        rowDiv.appendChild(checkbox);
      });

      // 5) Add info/legend at bottom
      const infoDiv = document.createElement('div');
      infoDiv.className = "info";
      infoDiv.innerHTML = `
        <ul>
          <li>The green bar spans from <em>startDate</em> to <em>dueDate</em>.</li>
          <li>The red line shows "today" if it falls between the earliest start and latest due date.</li>
          <li>An orange diamond indicates the <em>oral exam date</em> (if relevant).</li>
          <li>Check the box to mark a chapter as completed (stored in Local Storage).</li>
        </ul>
      `;
      // Position it after the rows (so it doesn't overlap them)
      infoDiv.style.position = "absolute";
      infoDiv.style.top = (AXIS_HEIGHT + data.length * ROW_HEIGHT + 20) + "px";
      infoDiv.style.left = "0";
      infoDiv.style.width = (LABEL_WIDTH + chartWidth) + "px";

      container.appendChild(infoDiv);
    }
  </script>
</body>
</html>
