<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Improved Gantt Chart (Full Page)</title>
  <style>
    /* Make the entire page fill the window */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden; /* We'll let the #chart-container scroll instead */
    }

    /* Scrollable container that fills the page */
    #chart-container {
      width: 100%;
      height: 100%;
      overflow: auto; /* Enable scrollbars if content is large */
      position: relative;
      background: #fff;
    }

    /* Some spacing at the top for the heading/info */
    .chart-header {
      padding: 1rem;
    }

    /* The "chart-inner" will hold the entire axis + rows at absolute positions */
    #chart-inner {
      position: relative;
      /* We'll set its width/height in JS based on timeline size and row count */
    }

    /* The top date-axis bar */
    .date-axis {
      position: absolute;
      top: 0;
      left: 0;
      height: 30px;
      background: #f9f9f9;
      border-bottom: 1px solid #999;
      z-index: 10;
    }
    .date-tick {
      position: absolute;
      top: 0;
      width: 1px;
      height: 100%;
      background: #999;
    }
    .date-label {
      position: absolute;
      top: 2px;
      transform: translateX(-50%);
      font-size: 0.8em;
      color: #333;
      white-space: nowrap;
    }

    /* The red line for "today" */
    .today-line {
      position: absolute;
      top: 0;
      width: 2px;
      background: red;
      pointer-events: none;
      z-index: 5;
    }

    /* Each row is absolutely positioned below the axis */
    .gantt-row {
      position: absolute;
      left: 0;
      height: 30px; /* or ROW_HEIGHT */
      z-index: 1; /* base layer */
    }

    /* Label pinned to the left within the row */
    .gantt-label {
      position: absolute;
      left: 0;
      width: 130px; /* or LABEL_WIDTH */
      text-align: right;
      padding-right: 8px;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      z-index: 3; /* on top of bar */
      background: #fff; /* so it's not overlapped by the bar */
    }

    /* Green bar representing the timeframe */
    .gantt-bar {
      position: absolute;
      top: 0;
      height: 30px;
      background-color: #4CAF50;
      z-index: 1;
    }

    /* Orange diamond for oral exam date */
    .exam-marker {
      position: absolute;
      width: 14px;
      height: 14px;
      background-color: orange;
      transform: rotate(45deg);
      top: 8px; /* center diamond in 30px row */
      z-index: 4; /* above bar and label */
    }

    /* Completion checkbox, placed near the label */
    .completion-checkbox {
      position: absolute;
      left: -20px; /* shift left of label */
      top: 5px;
      z-index: 4; /* above bar */
    }

    /* Info at the bottom */
    .info {
      position: absolute;
      left: 0;
      color: #555;
      font-size: 0.9em;
      z-index: 2; /* above the bars but below the diamond if it overlaps */
      background: #fff;
      padding: 0.5rem;
      border-top: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div id="chart-container">
    <div class="chart-header">
      <h1>Improved Gantt Chart (Full Page)</h1>
      <p>
        Loads <code>chapters/chapter_X.json</code> based on <strong>?chapter=X</strong>.
        Example: <code>gantt_improved.html?chapter=1</code>.
      </p>
    </div>

    <!-- We'll create/position everything in JS inside #chart-inner -->
    <div id="chart-inner"></div>
  </div>

  <script>
    // === CONFIGURABLE PARAMETERS ===
    const PIXELS_PER_DAY = 5;
    const AXIS_HEIGHT = 30;
    const ROW_HEIGHT = 30;
    const LABEL_WIDTH = 130;
    // ===============================

    // 1. Determine the JSON file from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const chapterParam = urlParams.get("chapter") || "1";
    const jsonPath = `chapters/chapter_${chapterParam}.json`;

    // 2. Fetch the JSON data
    fetch(jsonPath)
      .then(res => {
        if (!res.ok) {
          throw new Error(`Error loading JSON: ${res.status} ${res.statusText}`);
        }
        return res.json();
      })
      .then(chapters => {
        buildGantt(chapters);
      })
      .catch(err => {
        console.error(err);
        document.getElementById("chart-inner").textContent =
          "Error loading data. Check console for details.";
      });

    function parseDate(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split("-");
      if (parts.length !== 3) return null;
      const [year, month, day] = parts.map(n => parseInt(n, 10));
      return new Date(year, month - 1, day);
    }

    function buildGantt(chapters) {
      // 1. Parse relevant fields
      const data = chapters.map(ch => ({
        ...ch,
        start: parseDate(ch.startDate),
        due: parseDate(ch.dueDate),
        exam: parseDate(ch.oralExamDate)
      })).filter(ch => ch.start && ch.due);

      if (data.length === 0) {
        document.getElementById("chart-inner").innerHTML = "<p>No valid startDate/dueDate found.</p>";
        return;
      }

      // 2. Determine minStart / maxDue
      const minStart = new Date(Math.min(...data.map(ch => ch.start)));
      const maxDue = new Date(Math.max(...data.map(ch => ch.due)));
      const msPerDay = 1000 * 60 * 60 * 24;
      const totalDays = Math.round((maxDue - minStart) / msPerDay);

      // 3. Calculate the needed width/height
      const chartWidth = totalDays * PIXELS_PER_DAY + LABEL_WIDTH + 50; 
      // +50 as a little buffer on the right
      const chartHeight = AXIS_HEIGHT + data.length * ROW_HEIGHT + 100; 
      // +100 for info text at bottom

      const chartInner = document.getElementById("chart-inner");
      chartInner.style.width = chartWidth + "px";
      chartInner.style.height = chartHeight + "px";

      // === CREATE THE DATE AXIS ===
      const axis = document.createElement("div");
      axis.className = "date-axis";
      axis.style.width = (chartWidth - LABEL_WIDTH) + "px"; // axis spans only the timeline
      axis.style.left = LABEL_WIDTH + "px";
      axis.style.height = AXIS_HEIGHT + "px";
      chartInner.appendChild(axis);

      // Weekly ticks
      for (let d = new Date(minStart); d <= maxDue; d.setDate(d.getDate() + 7)) {
        const offsetDays = Math.round((d - minStart) / msPerDay);
        const xPos = offsetDays * PIXELS_PER_DAY;
        
        // Tick line
        const tick = document.createElement("div");
        tick.className = "date-tick";
        tick.style.left = xPos + "px";
        axis.appendChild(tick);

        // Label
        const label = document.createElement("div");
        label.className = "date-label";
        label.style.left = xPos + "px";
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        label.textContent = `${d.getFullYear()}-${mm}-${dd}`;
        axis.appendChild(label);
      }

      // === TODAY LINE ===
      const today = new Date();
      if (today >= minStart && today <= maxDue) {
        const offsetToday = Math.round((today - minStart) / msPerDay);
        const todayX = offsetToday * PIXELS_PER_DAY + LABEL_WIDTH;
        const todayLine = document.createElement("div");
        todayLine.className = "today-line";
        todayLine.style.left = todayX + "px";
        todayLine.style.height = chartHeight + "px";
        chartInner.appendChild(todayLine);
      }

      // === ROWS (CHAPTERS) ===
      data.forEach((ch, i) => {
        const rowTop = AXIS_HEIGHT + i * ROW_HEIGHT;

        // Create a row container
        const rowDiv = document.createElement("div");
        rowDiv.className = "gantt-row";
        rowDiv.style.top = rowTop + "px";
        rowDiv.style.width = chartWidth + "px"; 
        rowDiv.style.height = ROW_HEIGHT + "px";
        chartInner.appendChild(rowDiv);

        // Label
        const labelSpan = document.createElement("span");
        labelSpan.className = "gantt-label";
        labelSpan.textContent = `Chapter ${ch.chapter}`;
        labelSpan.style.top = "0px";
        rowDiv.appendChild(labelSpan);

        // The bar offset
        const offsetDays = Math.round((ch.start - minStart) / msPerDay);
        const barLeft = offsetDays * PIXELS_PER_DAY + LABEL_WIDTH;

        // The bar width
        const durationDays = Math.round((ch.due - ch.start) / msPerDay);
        const barWidth = durationDays * PIXELS_PER_DAY;

        // The bar
        const barDiv = document.createElement("div");
        barDiv.className = "gantt-bar";
        barDiv.style.left = barLeft + "px";
        barDiv.style.width = barWidth + "px";
        barDiv.title = `Start: ${ch.startDate} | Due: ${ch.dueDate}`;
        rowDiv.appendChild(barDiv);

        // Oral exam diamond if relevant
        if (ch.oralExamRelevant === true && ch.exam) {
          if (ch.exam >= minStart && ch.exam <= maxDue) {
            const examOffset = Math.round((ch.exam - minStart) / msPerDay);
            const examLeft = examOffset * PIXELS_PER_DAY + LABEL_WIDTH;
            const examMarker = document.createElement("div");
            examMarker.className = "exam-marker";
            examMarker.style.left = examLeft + "px";
            examMarker.title = `Oral Exam: ${ch.oralExamDate}`;
            rowDiv.appendChild(examMarker);
          }
        }

        // Completion checkbox
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "completion-checkbox";
        const storageKey = `improved-gantt-chapter${chapterParam}-row${i}-completed`;
        checkbox.checked = localStorage.getItem(storageKey) === "true";
        checkbox.addEventListener("change", () => {
          localStorage.setItem(storageKey, checkbox.checked.toString());
        });
        rowDiv.appendChild(checkbox);
      });

      // === INFO/LEGEND AT BOTTOM ===
      const infoDiv = document.createElement("div");
      infoDiv.className = "info";
      infoDiv.style.top = (AXIS_HEIGHT + data.length * ROW_HEIGHT + 10) + "px";
      infoDiv.style.width = chartWidth + "px";
      infoDiv.innerHTML = `
        <p><strong>Legend:</strong></p>
        <ul>
          <li>Green bar: <em>startDate</em> to <em>dueDate</em>.</li>
          <li>Red line: "Today" (if in range).</li>
          <li>Orange diamond: <em>oralExamDate</em> (if relevant).</li>
          <li>Checkbox: Mark chapter as completed (saved in Local Storage).</li>
        </ul>
      `;
      chartInner.appendChild(infoDiv);
    }
  </script>
</body>
</html>
