<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Improved Gantt Chart</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h1 {
      margin-bottom: 0.5em;
    }

    #chart-container {
      position: relative;
      border: 1px solid #ccc;
      margin-top: 1em;
      overflow: hidden; /* Ensures bars and axis are clipped if too wide */
    }

    /* The horizontal axis at the top */
    .date-axis {
      position: absolute;
      top: 0;
      left: 0;
      height: 30px;
      border-bottom: 1px solid #999;
      background: #f9f9f9;
    }
    .date-tick {
      position: absolute;
      top: 0;
      height: 100%;
      width: 1px;
      background: #999;
    }
    .date-label {
      position: absolute;
      top: 2px;
      transform: translateX(-50%);
      font-size: 0.8em;
      color: #333;
    }

    /* Each row (chapter) is positioned absolutely within the chart */
    .gantt-row {
      position: absolute;
      left: 0;
      height: 20px;
      display: flex;
      align-items: center;
    }

    /* The label for the chapter, pinned to the left side outside the chart area */
    .gantt-label {
      position: absolute;
      left: -120px;
      width: 110px;
      text-align: right;
      padding-right: 10px;
      font-weight: bold;
    }

    /* The bar representing the time span */
    .gantt-bar {
      position: absolute;
      top: 0;
      height: 20px;
      background-color: #4CAF50;
    }

    /* The "today" line */
    .today-line {
      position: absolute;
      top: 0;
      width: 2px;
      height: 100%;
      background: red;
      pointer-events: none; /* let clicks pass through */
    }

    /* Completion checkbox placed at the right end of the bar or next to the label */
    .completion-checkbox {
      position: absolute;
      left: 5px;
      top: 0;
      transform: translateX(-120%);
    }

    /* Legend or info at the bottom */
    .info {
      margin-top: 20px;
      font-size: 0.9em;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Improved Gantt Chart</h1>
  <p>
    This page loads a JSON file from <code>chapters/chapter_X.json</code> based on
    <strong>?chapter=X</strong> in the URL (e.g. <code>gantt_improved.html?chapter=1</code>).
  </p>

  <!-- The chart container will be dynamically sized by JavaScript -->
  <div id="chart-container">
    <!-- Axis and bars will be injected here -->
  </div>

  <div class="info">
    <ul>
      <li>The green bar spans from <em>startDate</em> to <em>dueDate</em>.</li>
      <li>The red line indicates "today" if it falls between the earliest start and latest due date.</li>
      <li>Check the box to mark a chapter as completed (stored in Local Storage).</li>
    </ul>
  </div>

  <script>
    // === CONFIGURABLE PARAMETERS ===
    const PIXELS_PER_DAY = 5;    // Adjust for bar length scaling
    const ROW_HEIGHT = 30;       // Vertical spacing per row
    const AXIS_HEIGHT = 30;      // Space at the top for the date axis
    const LABEL_WIDTH = 120;     // Space to the left for labels
    // ===============================

    // 1. Determine which JSON file to load from URL ?chapter=X
    const urlParams = new URLSearchParams(window.location.search);
    const chapterParam = urlParams.get('chapter') || "1";
    const jsonPath = `chapters/chapter_${chapterParam}.json`;

    // 2. Fetch the JSON data
    fetch(jsonPath)
      .then(res => {
        if (!res.ok) {
          throw new Error(`Could not load JSON: ${res.status} ${res.statusText}`);
        }
        return res.json();
      })
      .then(chapters => {
        createImprovedGantt(chapters);
      })
      .catch(err => {
        console.error(err);
        document.getElementById("chart-container").textContent =
          "Error loading data. Check console for details.";
      });

    // Helper: parse a "YYYY-MM-DD" string into a Date object
    function parseDate(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split("-");
      if (parts.length !== 3) return null;
      const year = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1;
      const day = parseInt(parts[2], 10);
      return new Date(year, month, day);
    }

    function createImprovedGantt(chapters) {
      // 1. Parse all dates and find the overall minStart and maxDue
      const parsed = chapters.map(ch => {
        return {
          ...ch,
          start: parseDate(ch.startDate),
          due: parseDate(ch.dueDate)
        };
      }).filter(ch => ch.start && ch.due); // Only keep items with valid dates

      if (parsed.length === 0) {
        document.getElementById("chart-container").textContent = "No valid date data found.";
        return;
      }

      const minStart = new Date(Math.min(...parsed.map(ch => ch.start)));
      const maxDue = new Date(Math.max(...parsed.map(ch => ch.due)));
      const totalDays = Math.round((maxDue - minStart) / (1000 * 60 * 60 * 24));
      const chartWidth = totalDays * PIXELS_PER_DAY;
      const chartHeight = parsed.length * ROW_HEIGHT + AXIS_HEIGHT;

      // 2. Size the chart container
      const container = document.getElementById("chart-container");
      container.style.width = (chartWidth + LABEL_WIDTH + 20) + "px";
      container.style.height = chartHeight + "px";

      // 3. Create the date axis at the top
      const axis = document.createElement('div');
      axis.className = 'date-axis';
      axis.style.width = chartWidth + 'px';
      axis.style.left = LABEL_WIDTH + 'px'; // push right for label space
      axis.style.height = AXIS_HEIGHT + 'px';
      container.appendChild(axis);

      // 3a. Add ticks for each week between minStart and maxDue
      //     (For brevity, we do weekly increments, can refine as needed.)
      const oneDay = 1000 * 60 * 60 * 24;
      for (let d = new Date(minStart), i = 0; d <= maxDue; d.setDate(d.getDate() + 7), i++) {
        const offsetDays = Math.round((d - minStart) / oneDay);
        const xPos = offsetDays * PIXELS_PER_DAY;

        // Tick line
        const tick = document.createElement('div');
        tick.className = 'date-tick';
        tick.style.left = xPos + 'px';
        axis.appendChild(tick);

        // Label
        const label = document.createElement('div');
        label.className = 'date-label';
        label.style.left = xPos + 'px';
        // Format date (YYYY-MM-DD)
        const month = (d.getMonth() + 1).toString().padStart(2, "0");
        const day = d.getDate().toString().padStart(2, "0");
        label.textContent = `${d.getFullYear()}-${month}-${day}`;
        axis.appendChild(label);
      }

      // 4. Add a "today" line if within range
      const today = new Date();
      if (today >= minStart && today <= maxDue) {
        const todayOffsetDays = Math.round((today - minStart) / oneDay);
        const todayX = todayOffsetDays * PIXELS_PER_DAY;

        const todayLine = document.createElement('div');
        todayLine.className = 'today-line';
        todayLine.style.left = (LABEL_WIDTH + todayX) + 'px';
        todayLine.style.height = chartHeight + 'px';
        container.appendChild(todayLine);
      }

      // 5. Create a row for each chapter
      parsed.forEach((ch, idx) => {
        const rowTop = AXIS_HEIGHT + idx * ROW_HEIGHT;

        const rowDiv = document.createElement('div');
        rowDiv.className = 'gantt-row';
        rowDiv.style.top = rowTop + 'px';
        rowDiv.style.width = (chartWidth + LABEL_WIDTH) + 'px';

        // Chapter label on the left
        const label = document.createElement('span');
        label.className = 'gantt-label';
        label.textContent = `Chapter ${ch.chapter}`;
        rowDiv.appendChild(label);

        // Position the bar according to the offset from minStart
        const offsetDays = Math.round((ch.start - minStart) / oneDay);
        const barLeft = offsetDays * PIXELS_PER_DAY + LABEL_WIDTH;
        const durationDays = Math.round((ch.due - ch.start) / oneDay);
        const barWidth = durationDays * PIXELS_PER_DAY;

        // The bar element
        const bar = document.createElement('div');
        bar.className = 'gantt-bar';
        bar.style.left = barLeft + 'px';
        bar.style.width = barWidth + 'px';
        bar.title = `Start: ${ch.startDate}, Due: ${ch.dueDate}`;
        rowDiv.appendChild(bar);

        // Local Storage completion checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'completion-checkbox';
        const storageKey = `improved-gantt-chapter${chapterParam}-row${idx}-completed`;
        checkbox.checked = localStorage.getItem(storageKey) === "true";
        checkbox.addEventListener('change', () => {
          localStorage.setItem(storageKey, checkbox.checked.toString());
        });
        rowDiv.appendChild(checkbox);

        container.appendChild(rowDiv);
      });
    }
  </script>
</body>
</html>
